---
import * as userStore from "./store";

if (userStore.selectedUserId) {
  return new Response(
    JSON.stringify({
      error: `user ${userStore.selectedUserId} already pressed the buzzer`,
    }),
    {
      status: 400,
      headers: {
        "Content-Type": "text/plain",
      },
    }
  );
}

const body = (await Astro.request.json()) as unknown;

if (
  typeof body === "object" &&
  body !== null &&
  "userId" in body &&
  typeof body.userId === "string" &&
  !Number.isNaN(Number(body.userId))
) {
  userStore.setSelectedUserId(Number(body.userId));
  setTimeout(() => {
    userStore.setSelectedUserId(null);
  }, 1000);
  return new Response(
    JSON.stringify({
      userId: body.userId,
      message: "buzzer pressed",
    }),
    {
      status: 200,
      headers: {
        "Content-Type": "text/plain",
      },
    }
  );
}

return new Response(
  JSON.stringify({
    error: "invalid request",
  }),
  {
    status: 400,
    headers: {
      "Content-Type": "text/plain",
    },
  }
);
---
